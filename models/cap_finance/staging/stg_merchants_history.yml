version: 2

models:
  - name: stg_merchants_history
    description: >
      Merchant dimension history in Kimball SCD2 form.
      Grain: (merchant_id, valid_from) representing one effective version of a merchant record.
      Validity windows are non-overlapping per merchant_id and open-ended rows use valid_to = 9999-12-31.
      This model is used to enrich settlements with the correct legal_entity/country as-of ledger_business_date.

    columns:

      - name: merchant_sk
        description: >
          Surrogate key for a merchant version row, typically generated from (merchant_id, valid_from).
          Uniquely identifies a single SCD2 version of a merchant.
        tests:
          - not_null
          - unique

      - name: merchant_id
        description: "Natural merchant identifier from CRM."
        tests:
          - not_null

      - name: merchant_name
        description: "Merchant display name from CRM."
        tests:
          - not_null

      - name: legal_entity
        description: >
          Finance reporting legal entity for the merchant version.
          Used as the entity lens for reconciliation at the control grain.
        tests:
          - not_null

      - name: country
        description: >
          Merchant country code (normalized to uppercase).
          Used for entity mapping, business day calendars, and validation.
        tests:
          - not_null
          - accepted_values:
              values: ['US', 'CA', 'GB']

      - name: valid_from
        description: >
          Start date (inclusive) for this merchant version.
          Used in as-of joins (ledger_business_date BETWEEN valid_from AND valid_to).
        tests:
          - not_null

      - name: valid_to
        description: >
          End date (inclusive) for this merchant version.
          Open-ended rows are set to 9999-12-31 to enable BETWEEN as-of joins.
        tests:
          - not_null

    tests:

      # 1) Validity window sanity
      - dbt_utils.expression_is_true:
          name: valid_window_non_negative
          expression: "valid_to >= valid_from"

      # 2) Enforce one open-ended row per merchant_id (Kimball high-date convention)
      - dbt_utils.expression_is_true:
          name: exactly_one_open_row_per_merchant
          expression: |
            merchant_id IN (
              SELECT merchant_id
              FROM {{ ref('stg_merchants_scd2') }}
              GROUP BY merchant_id
              HAVING SUM(CASE WHEN valid_to = DATE '9999-12-31' THEN 1 ELSE 0 END) = 1
            )

      # 3) No overlapping validity windows per merchant_id
      - dbt_utils.expression_is_true:
          name: no_overlapping_windows
          expression: |
            NOT EXISTS (
              SELECT 1
              FROM {{ ref('stg_merchants_scd2') }} a
              JOIN {{ ref('stg_merchants_scd2') }} b
                ON a.merchant_id = b.merchant_id
               AND a.valid_from < b.valid_from
               AND b.valid_from <= a.valid_to
            )

      # 4) Ensure the grain uniqueness at the business key level too
      - dbt_utils.unique_combination_of_columns:
          name: unique_merchant_version_grain
          combination_of_columns:
            - merchant_id
            - valid_from
